pipeline {
    agent any
    stages {
      //백엔드
            stage('Springboot build') {
                steps {
                    dir('Server/webserver'){
                        sh '''
                        pwd
                        echo 'springboot build'
                        chmod +x gradlew
                        ./gradlew clean build
                        '''
                    }
                }
            }
            stage('Dockerimage build') {
                steps {
                    dir('Server/webserver'){
                        sh '''
                        echo 'Dockerimage build'
                        docker build -t docker-springboot:0.0.1 .
                        '''
                    }
                }
            }
            stage('Deploy') {
                steps {
                    dir('Server/webserver'){

                        sh '''
                        echo 'Deploy'

                        result=$( docker container ls -a --filter "name=*back" -q )
                        if [ -n "$result" ]
                            then
                                docker stop cyes_back
                                docker rm cyes_back
                            
                            else
                                echo "No such containers"
                            fi
                            
                        docker run -d -p 127.0.0.1:5000:5000 --name cyes_back docker-springboot:0.0.1
                        docker images -f "dangling=true" -q | xargs -r docker rmi
                        '''
                    }
                }
            }
      

        //프론트 엔드
          stage('FE build') {
            steps {
                dir('Frontend/cyesfront'){
                    sh '''
                        pwd
                        echo 'Frontend build'
                        
                        CI=false npm run build
                    '''
                }
            }
        }
        stage('Dockerimage build') {
            steps {
                dir('Frontend/cyesfront'){
                    sh '''
                        echo 'Dockerimage build'
                        docker build --no-cache -t cyes_front .
                    '''
                }
            }
        }
        stage('FE Deploy') {
            steps {
                dir('Frontend/cyesfront'){

                    sh '''
                        echo 'FE Deploy'

                        result=$( docker container ls -a --filter "name=*front" -q )
                        if [ -n "$result" ]
                            then
                                docker stop cyes_front
                                docker rm cyes_front
                            
                            else
                                echo "No such containers"
                            fi
                            
                        docker run -d -p 127.0.0.1:9510:9510 --name cyes_front 
                        docker images -f "dangling=true" -q | xargs -r docker rmi
                    '''
                }
            }
        }

    }
}
